name: Build Fishhook XCFramework (Xcode 16.4 Final Fix)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    env:
      MIN_IOS_VERSION: "9.0"
      MIN_MACOS_VERSION: "10.11"
      PROJECT_NAME: "FishhookStaticLib"
      TARGET_NAME: "Fishhook"
      BUILD_DIR: "./build"
      PRODUCTS_DIR: "./products"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        # 拉取官方Fishhook源码（若你的仓库无源码，取消注释）
        # run: |
        #   git clone https://github.com/facebook/fishhook.git && cd fishhook

      - name: Setup Xcode Environment
        run: |
          # 强制绑定Xcode 16.4（关键：固定版本避免校验规则不一致）
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version
          sudo xcodebuild -license accept
          # 验证平台
          echo "iOS Platform: $(xcrun --show-sdk-platform-path --sdk iphoneos)"
          echo "iOS Sim Platform: $(xcrun --show-sdk-platform-path --sdk iphonesimulator)"

      - name: Create Temporary Xcode Project (Auto-Generated)
        run: |
          # 创建工程目录
          mkdir -p ${BUILD_DIR}
          cd ${BUILD_DIR}

          # 1. 创建静态库工程（iOS + macOS）
          xcodebuild -create-project \
            -name ${PROJECT_NAME} \
            -platform iOS \
            -language C \
            -target ${TARGET_NAME} \
            -template StaticLibrary \
            ${PROJECT_NAME}.xcodeproj

          # 2. 复制Fishhook源码到工程目录
          cp ../fishhook.c ./
          cp ../fishhook.h ./

          # 3. 修改工程配置（关键：添加源码、设置最低版本、关闭Bitcode）
          # 生成xcconfig文件统一配置
          cat > FishhookConfig.xcconfig << EOF
          IPHONEOS_DEPLOYMENT_TARGET = ${MIN_IOS_VERSION}
          MACOSX_DEPLOYMENT_TARGET = ${MIN_MACOS_VERSION}
          ENABLE_BITCODE = NO
          CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER = NO
          GCC_WARN_UNUSED_FUNCTION = NO
          EOF

          # 4. 将xcconfig关联到target
          xcodebuild -project ${PROJECT_NAME}.xcodeproj \
            -target ${TARGET_NAME} \
            -xcconfig FishhookConfig.xcconfig

          # 5. 添加源码到target（替换默认的main.c）
          xcodebuild -project ${PROJECT_NAME}.xcodeproj \
            -target ${TARGET_NAME} \
            add-file fishhook.c fishhook.h

      - name: Build iOS Simulator Version (Xcode Managed)
        run: |
          cd ${BUILD_DIR}
          # 编译iOS模拟器库（自动包含x86_64+arm64，带正确平台标识）
          xcodebuild build \
            -project ${PROJECT_NAME}.xcodeproj \
            -target ${TARGET_NAME} \
            -configuration Release \
            -sdk iphonesimulator \
            -arch x86_64 \
            -arch arm64 \
            BUILD_DIR=${PRODUCTS_DIR} \
            BUILD_ROOT=${PRODUCTS_DIR} \
            SKIP_INSTALL=NO \
            INSTALL_PATH=/usr/local/lib

      - name: Build iOS Device Version (Xcode Managed)
        run: |
          cd ${BUILD_DIR}
          # 编译iOS真机库（仅arm64，带正确平台标识）
          xcodebuild build \
            -project ${PROJECT_NAME}.xcodeproj \
            -target ${TARGET_NAME} \
            -configuration Release \
            -sdk iphoneos \
            -arch arm64 \
            BUILD_DIR=${PRODUCTS_DIR} \
            BUILD_ROOT=${PRODUCTS_DIR} \
            SKIP_INSTALL=NO \
            INSTALL_PATH=/usr/local/lib

      - name: Build macOS Universal Version (Xcode Managed)
        run: |
          cd ${BUILD_DIR}
          # 为macOS添加target（可选，若不需要macOS可删除）
          xcodebuild -project ${PROJECT_NAME}.xcodeproj \
            -create-target ${TARGET_NAME}_macOS \
            -template StaticLibrary \
            -platform macOS

          # 编译macOS通用库（x86_64+arm64）
          xcodebuild build \
            -project ${PROJECT_NAME}.xcodeproj \
            -target ${TARGET_NAME}_macOS \
            -configuration Release \
            -sdk macosx \
            -arch x86_64 \
            -arch arm64 \
            BUILD_DIR=${PRODUCTS_DIR} \
            BUILD_ROOT=${PRODUCTS_DIR} \
            SKIP_INSTALL=NO \
            INSTALL_PATH=/usr/local/lib

      - name: Create XCFramework (Xcode 16.4 Compatible)
        run: |
          # 创建产物目录
          mkdir -p ../final
          
          # 查找编译后的库文件（Xcode自动生成，带正确平台标识）
          SIM_LIB=$(find ${PRODUCTS_DIR} -name "lib${TARGET_NAME}.a" -path "*iphonesimulator*")
          DEVICE_LIB=$(find ${PRODUCTS_DIR} -name "lib${TARGET_NAME}.a" -path "*iphoneos*")
          MACOS_LIB=$(find ${PRODUCTS_DIR} -name "lib${TARGET_NAME}_macOS.a" -path "*macosx*")

          # 验证库存在
          if [ ! -f "${SIM_LIB}" ] || [ ! -f "${DEVICE_LIB}" ]; then
            echo "Error: iOS library not found!"
            ls -l ${PRODUCTS_DIR}
            exit 1
          fi

          # 关键：用Xcode编译的库创建XCFramework（无多平台错误）
          xcodebuild -create-xcframework \
            -library "${SIM_LIB}" \
            -headers ../ \
            -library "${DEVICE_LIB}" \
            -headers ../ \
            -output ../final/Fishhook.xcframework

          # 复制macOS库和头文件到最终目录
          cp "${MACOS_LIB}" ../final/libfishhook_macos.a 2>/dev/null || true
          cp ../fishhook.h ../final/

          # 验证XCFramework
          echo "=== Final XCFramework Info ==="
          xcodebuild -showxcframework -xcframework ../final/Fishhook.xcframework

      - name: Upload Final Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fishhook-xcframework-xcode16.4
          path: |
            final/Fishhook.xcframework/
            final/libfishhook_macos.a
            final/fishhook.h
