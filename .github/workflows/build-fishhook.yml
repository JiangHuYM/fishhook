name: Build Fishhook XCFramework (Xcode 16.4 Compatible)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    env:
      MIN_IOS_VERSION: "9.0"
      MIN_MACOS_VERSION: "10.11"
      BUILD_DIR: "./build"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        # 若需拉取官方Fishhook源码，替换为：
        # run: |
        #   git clone https://github.com/facebook/fishhook.git && cd fishhook

      - name: Setup Xcode Environment
        run: |
          # 强制使用Xcode 16.4（Runner默认可能有多个版本）
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version
          sudo xcodebuild -license accept
          # 验证SDK路径
          echo "iOS Sim SDK: $(xcrun --show-sdk-path --sdk iphonesimulator)"
          echo "iOS Device SDK: $(xcrun --show-sdk-path --sdk iphoneos)"
          echo "macOS SDK: $(xcrun --show-sdk-path --sdk macosx)"

      - name: Create Build Directories
        run: |
          mkdir -p ${BUILD_DIR}/ios-sim/x86_64 \
                   ${BUILD_DIR}/ios-sim/arm64 \
                   ${BUILD_DIR}/ios-device/arm64 \
                   ${BUILD_DIR}/macos/x86_64 \
                   ${BUILD_DIR}/macos/arm64

      - name: Compile Single-Architecture Object Files
        run: |
          # ==================== macOS 单架构编译 ====================
          # macOS x86_64
          clang -c fishhook.c \
            -o ${BUILD_DIR}/macos/x86_64/fishhook.o \
            -arch x86_64 \
            -isysroot $(xcrun --show-sdk-path --sdk macosx) \
            -mmacosx-version-min=${MIN_MACOS_VERSION}
          ar rcs ${BUILD_DIR}/macos/x86_64/libfishhook.a ${BUILD_DIR}/macos/x86_64/fishhook.o

          # macOS arm64
          clang -c fishhook.c \
            -o ${BUILD_DIR}/macos/arm64/fishhook.o \
            -arch arm64 \
            -isysroot $(xcrun --show-sdk-path --sdk macosx) \
            -mmacosx-version-min=${MIN_MACOS_VERSION}
          ar rcs ${BUILD_DIR}/macos/arm64/libfishhook.a ${BUILD_DIR}/macos/arm64/fishhook.o

          # ==================== iOS 模拟器单架构编译 ====================
          # iOS Sim x86_64
          clang -c fishhook.c \
            -o ${BUILD_DIR}/ios-sim/x86_64/fishhook.o \
            -arch x86_64 \
            -isysroot $(xcrun --show-sdk-path --sdk iphonesimulator) \
            -mios-version-min=${MIN_IOS_VERSION}
          ar rcs ${BUILD_DIR}/ios-sim/x86_64/libfishhook.a ${BUILD_DIR}/ios-sim/x86_64/fishhook.o

          # iOS Sim arm64
          clang -c fishhook.c \
            -o ${BUILD_DIR}/ios-sim/arm64/fishhook.o \
            -arch arm64 \
            -isysroot $(xcrun --show-sdk-path --sdk iphonesimulator) \
            -mios-version-min=${MIN_IOS_VERSION}
          ar rcs ${BUILD_DIR}/ios-sim/arm64/libfishhook.a ${BUILD_DIR}/ios-sim/arm64/fishhook.o

          # ==================== iOS 真机单架构编译 ====================
          # iOS Device arm64
          clang -c fishhook.c \
            -o ${BUILD_DIR}/ios-device/arm64/fishhook.o \
            -arch arm64 \
            -isysroot $(xcrun --show-sdk-path --sdk iphoneos) \
            -mios-version-min=${MIN_IOS_VERSION}
          ar rcs ${BUILD_DIR}/ios-device/arm64/libfishhook.a ${BUILD_DIR}/ios-device/arm64/fishhook.o

      - name: Merge Single-Architecture Libraries (Per Platform)
        run: |
          # 合并macOS多架构库（单平台内的胖文件，无警告）
          lipo -create \
            ${BUILD_DIR}/macos/x86_64/libfishhook.a \
            ${BUILD_DIR}/macos/arm64/libfishhook.a \
            -output libfishhook_macos.a

          # 合并iOS模拟器多架构库（单平台内的胖文件，解决ranlib警告）
          lipo -create \
            ${BUILD_DIR}/ios-sim/x86_64/libfishhook.a \
            ${BUILD_DIR}/ios-sim/arm64/libfishhook.a \
            -output ${BUILD_DIR}/ios-sim/libfishhook_ios_sim.a

          # iOS真机仅arm64，直接复制
          cp ${BUILD_DIR}/ios-device/arm64/libfishhook.a ${BUILD_DIR}/ios-device/libfishhook_ios_device.a

          # 验证单平台库架构（无跨平台问题）
          echo "=== macOS 库架构 ==="
          lipo -info libfishhook_macos.a
          echo "=== iOS 模拟器库架构 ==="
          lipo -info ${BUILD_DIR}/ios-sim/libfishhook_ios_sim.a
          echo "=== iOS 真机库架构 ==="
          lipo -info ${BUILD_DIR}/ios-device/libfishhook_ios_device.a

      - name: Create XCFramework (No Platform Conflict)
        run: |
          # 基于单平台库创建XCFramework，彻底解决架构冲突
          xcodebuild -create-xcframework \
            -library ${BUILD_DIR}/ios-sim/libfishhook_ios_sim.a \
            -headers ./ \
            -library ${BUILD_DIR}/ios-device/libfishhook_ios_device.a \
            -headers ./ \
            -output Fishhook.xcframework

          # 复制模拟器/真机库到根目录（方便单独使用）
          cp ${BUILD_DIR}/ios-sim/libfishhook_ios_sim.a ./
          cp ${BUILD_DIR}/ios-device/libfishhook_ios_device.a ./

          # 验证XCFramework结构
          echo "=== XCFramework 详情 ==="
          xcodebuild -showxcframework -xcframework Fishhook.xcframework

      - name: Upload Final Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fishhook-xcframework-16.4
          path: |
            Fishhook.xcframework/
            libfishhook_macos.a
            libfishhook_ios_sim.a
            libfishhook_ios_device.a
            fishhook.h
