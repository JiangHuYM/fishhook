name: Build Fishhook Static Library

# 触发条件：push/Pull Request 到 main 分支，或手动触发
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # 手动触发

# 运行作业
jobs:
  build:
    runs-on: macos-latest # 必须用 macOS 环境（Xcode 依赖）

    steps:
      # 步骤1：检出代码（如果 Fishhook 源码在你仓库中，直接用这个；否则替换为克隆官方仓库）
      - name: Checkout Code
        uses: actions/checkout@v4
        # 如果你的仓库没有 Fishhook 源码，替换为克隆官方仓库：
        # run: |
        #   git clone https://github.com/facebook/fishhook.git
        #   cd fishhook

      # 步骤2：确认 Xcode 环境，设置 SDK 路径
      - name: Setup Xcode Environment
        run: |
          # 显示 Xcode 版本
          xcodebuild -version
          # 设置 Xcode 路径（macOS 最新 runner 默认已配置，此处兜底）
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          # 打印 SDK 路径（验证）
          echo "macOS SDK Path: $(xcrun --show-sdk-path --sdk macosx)"
          echo "iOS Simulator SDK Path: $(xcrun --show-sdk-path --sdk iphonesimulator)"
          echo "iOS Device SDK Path: $(xcrun --show-sdk-path --sdk iphoneos)"

      # 步骤3：编译不同架构的静态库
      - name: Compile Fishhook Static Libraries
        run: |
          # 定义最低支持版本（Fishhook 最低支持 iOS 9/macOS 10.11）
          MIN_IOS_VERSION="9.0"
          MIN_MACOS_VERSION="10.11"

          # --------------------------
          # 1. 编译 macOS 通用静态库（x86_64 + arm64）
          # --------------------------
          clang -c fishhook.c \
            -o fishhook_macos.o \
            -arch x86_64 -arch arm64 \
            -isysroot $(xcrun --show-sdk-path --sdk macosx) \
            -mmacosx-version-min=${MIN_MACOS_VERSION}
          # 创建 macOS 静态库
          ar rcs libfishhook_macos.a fishhook_macos.o

          # --------------------------
          # 2. 编译 iOS 模拟器静态库（x86_64 + arm64）
          # --------------------------
          clang -c fishhook.c \
            -o fishhook_ios_sim.o \
            -arch x86_64 -arch arm64 \
            -isysroot $(xcrun --show-sdk-path --sdk iphonesimulator) \
            -mios-version-min=${MIN_IOS_VERSION}
          ar rcs libfishhook_ios_sim.a fishhook_ios_sim.o

          # --------------------------
          # 3. 编译 iOS 真机静态库（arm64）
          # --------------------------
          clang -c fishhook.c \
            -o fishhook_ios_device.o \
            -arch arm64 \
            -isysroot $(xcrun --show-sdk-path --sdk iphoneos) \
            -mios-version-min=${MIN_IOS_VERSION}
          ar rcs libfishhook_ios_device.a fishhook_ios_device.o

          # --------------------------
          # 4. 合并 iOS 模拟器+真机为通用静态库
          # --------------------------
          lipo -create \
            libfishhook_ios_sim.a \
            libfishhook_ios_device.a \
            -output libfishhook_ios.a

          # 验证静态库架构（可选，打印信息）
          echo "=== macOS 库架构 ==="
          lipo -info libfishhook_macos.a
          echo "=== iOS 通用库架构 ==="
          lipo -info libfishhook_ios.a

      # 步骤4：上传编译产物（方便下载）
      - name: Upload Static Libraries
        uses: actions/upload-artifact@v4
        with:
          name: fishhook-static-libs
          path: |
            libfishhook_macos.a
            libfishhook_ios.a
            libfishhook_ios_sim.a
            libfishhook_ios_device.a
            fishhook.h # 一并上传头文件
