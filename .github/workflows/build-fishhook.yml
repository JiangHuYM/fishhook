name: Build Fishhook Static Library

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        # 若需拉取官方源码，替换为：
        # run: |
        #   git clone https://github.com/facebook/fishhook.git
        #   cd fishhook

      - name: Setup Xcode Environment
        run: |
          xcodebuild -version
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          echo "macOS SDK: $(xcrun --show-sdk-path --sdk macosx)"
          echo "iOS Sim SDK: $(xcrun --show-sdk-path --sdk iphonesimulator)"
          echo "iOS Device SDK: $(xcrun --show-sdk-path --sdk iphoneos)"

      - name: Compile Single-Architecture Static Libraries
        run: |
          # 定义最低支持版本
          MIN_IOS_VERSION="9.0"
          MIN_MACOS_VERSION="10.11"

          # ==================== macOS 单架构编译 ====================
          # 1. macOS x86_64
          clang -c fishhook.c \
            -o fishhook_macos_x86_64.o \
            -arch x86_64 \
            -isysroot $(xcrun --show-sdk-path --sdk macosx) \
            -mmacosx-version-min=${MIN_MACOS_VERSION}
          ar rcs libfishhook_macos_x86_64.a fishhook_macos_x86_64.o

          # 2. macOS arm64 (Apple Silicon)
          clang -c fishhook.c \
            -o fishhook_macos_arm64.o \
            -arch arm64 \
            -isysroot $(xcrun --show-sdk-path --sdk macosx) \
            -mmacosx-version-min=${MIN_MACOS_VERSION}
          ar rcs libfishhook_macos_arm64.a fishhook_macos_arm64.o

          # 合并 macOS 多架构库（消除ranlib警告）
          lipo -create \
            libfishhook_macos_x86_64.a \
            libfishhook_macos_arm64.a \
            -output libfishhook_macos.a

          # ==================== iOS 模拟器单架构编译 ====================
          # 1. iOS 模拟器 x86_64 (Intel Mac)
          clang -c fishhook.c \
            -o fishhook_ios_sim_x86_64.o \
            -arch x86_64 \
            -isysroot $(xcrun --show-sdk-path --sdk iphonesimulator) \
            -mios-version-min=${MIN_IOS_VERSION}
          ar rcs libfishhook_ios_sim_x86_64.a fishhook_ios_sim_x86_64.o

          # 2. iOS 模拟器 arm64 (Apple Silicon Mac 模拟器)
          clang -c fishhook.c \
            -o fishhook_ios_sim_arm64.o \
            -arch arm64 \
            -isysroot $(xcrun --show-sdk-path --sdk iphonesimulator) \
            -mios-version-min=${MIN_IOS_VERSION}
          ar rcs libfishhook_ios_sim_arm64.a fishhook_ios_sim_arm64.o

          # 合并 iOS 模拟器多架构库
          lipo -create \
            libfishhook_ios_sim_x86_64.a \
            libfishhook_ios_sim_arm64.a \
            -output libfishhook_ios_sim.a

          # ==================== iOS 真机编译 (仅 arm64) ====================
          clang -c fishhook.c \
            -o fishhook_ios_device_arm64.o \
            -arch arm64 \
            -isysroot $(xcrun --show-sdk-path --sdk iphoneos) \
            -mios-version-min=${MIN_IOS_VERSION}
          ar rcs libfishhook_ios_device.a fishhook_ios_device_arm64.o

          # ==================== 合并 iOS 模拟器+真机 (解决架构重复问题) ====================
          # lipo 会自动区分「模拟器arm64」和「真机arm64」，无需手动处理
          lipo -create \
            libfishhook_ios_sim.a \
            libfishhook_ios_device.a \
            -output libfishhook_ios.a

          # 验证架构（关键：确认无重复架构）
          echo "=== macOS 库架构 ==="
          lipo -info libfishhook_macos.a
          echo "=== iOS 模拟器库架构 ==="
          lipo -info libfishhook_ios_sim.a
          echo "=== iOS 真机库架构 ==="
          lipo -info libfishhook_ios_device.a
          echo "=== iOS 通用库架构 ==="
          lipo -info libfishhook_ios.a

      - name: Upload Static Libraries
        uses: actions/upload-artifact@v4
        with:
          name: fishhook-static-libs
          path: |
            libfishhook_macos.a
            libfishhook_ios.a
            libfishhook_ios_sim.a
            libfishhook_ios_device.a
            fishhook.h
